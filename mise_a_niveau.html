<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Infrastructures - Province de Tan-Tan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #ea580c;
            --primary-dark: #c2410c;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.8);
            --glass-strong: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-wow: 0 25px 50px -12px rgba(234, 88, 12, 0.15);
            --glow-color: rgba(245, 158, 11, 0.4);
            --color-urbain: #ea580c;
            --color-rural: #f59e0b;
            --alert-red: #e11d48;
            --bar-commune: #ea580c;
            --bar-region: #fbbf24;
            --bar-national: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f1f5f9;
            color: #0f172a;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Master Background --- */
        .bg-master {
            position: fixed;
            inset: 0;
            background: url('img/sahara_maroc.jpeg') center/cover no-repeat;
            z-index: -1;
            filter: saturate(0.9) brightness(1);
            animation: bgPan 80s infinite alternate linear;
        }

        .bg-overlay {
            position: fixed;
            inset: 0;
            background: rgba(241, 245, 249, 0.88);
            backdrop-filter: blur(12px);
            z-index: -1;
        }

        @keyframes bgPan {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.15) translate(-2%, -1%);
            }
        }

        /* --- Premium Header --- */
        header {
            padding: 15px 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            position: relative;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(30, 58, 138, 0.1);
            z-index: 2000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
            animation: slideDown 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .header-center {
            text-align: center;
        }

        .pdti-subtitle {
            font-size: 1.1rem;
            font-weight: 800;
            background: linear-gradient(90deg, #ea580c, #f59e0b, #ea580c);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shineText 4s linear infinite;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        @keyframes shineText {
            to {
                background-position: 200% center;
            }
        }

        .maroc-separator {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: center;
        }

        .province-text {
            font-weight: 900;
            text-transform: uppercase;
            font-size: 1.3rem;
            color: #1a365d;
            letter-spacing: 3px;
        }

        .line {
            height: 2px;
            background: linear-gradient(to right, transparent, var(--accent), transparent);
            flex: 1;
            width: 100px;
            opacity: 0.6;
        }

        .logo-box {
            width: 75px;
            height: 75px;
            background: rgba(255, 143, 0, 0.1);
            border: 2px solid rgba(234, 88, 12, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 8px 20px rgba(234, 88, 12, 0.1);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            z-index: 2;
        }

        .logo-box:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 15px 30px rgba(245, 158, 11, 0.3);
            background: rgba(255, 255, 255, 1);
        }

        .logo-box img {
            width: 75%;
            height: auto;
            object-fit: contain;
        }

        .header-actions {
            position: absolute;
            right: 40px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Circular Icon Buttons */
        .btn-icon-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: white;
            color: #e11d48;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            font-size: 1.3rem;
        }

        .btn-icon-circle:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-icon-circle.btn-home {
            color: #f3a20d;
        }

        .btn-icon-circle.btn-diagnostic {
            color: #f3a20d;
        }

        .btn-icon-circle.btn-reset {
            color: #f3a20d;
        }

        .btn-premium {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.2);
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.3);
            background: #2563eb;
        }

        /* --- Middle Container --- */
        .middle-container {
            flex: 1;
            display: flex;
            padding: 20px 30px;
            gap: 20px;
            overflow: hidden;
            position: relative;
        }

        .side-panel {
            width: 350px;
            position: relative;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 25px 20px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 35px;
            box-shadow: var(--shadow-wow);
            overflow-y: auto;
            scrollbar-width: none;
        }

        .side-panel::-webkit-scrollbar {
            display: none;
        }

        #map-container {
            flex-grow: 1;
            position: relative;
            border-radius: 35px;
            overflow: hidden;
            box-shadow: var(--shadow-wow);
            border: 1px solid var(--glass-border);
            background: white;
        }

        #map-detail {
            width: 100%;
            height: 100%;
            transition: filter 0.5s ease;
        }

        /* --- Stats Cards --- */
        .ui-card {
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.03);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
            animation: cardFadeIn 0.8s ease backwards;
            margin-bottom: 10px;
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ui-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            border-color: var(--accent);
        }

        .indicator-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        /* --- Pill Style Card Headers --- */
        .card-profile-header {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 15px;
            margin: -10px auto 25px auto;
            width: 90%;
            border-radius: 50px;
            font-weight: 900;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: white;
            text-align: center;
            box-shadow: 0 10px 20px rgba(234, 88, 12, 0.2);
        }

        .indicator-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            animation: fadeInRight 0.5s ease backwards;
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .indicator-icon {
            width: 45px;
            height: 45px;
            background: #fff7ed;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .indicator-label {
            font-size: 0.95rem;
            font-weight: 800;
            color: #1a365d;
        }

        /* Tables Specifiques */
        .infra-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .infra-table th {
            background: #1e293b;
            color: white;
            padding: 12px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 800;
        }

        .infra-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.85rem;
            font-weight: 800;
            color: #1e293b;
        }

        .infra-table td:last-child {
            text-align: center;
            background: #f8fafc;
            color: #0f172a;
        }

        .deficit-card {
            background: #fff1f2;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #fecdd3;
        }

        .deficit-header {
            background: #e11d48;
            color: white;
            text-align: center;
            padding: 12px;
            font-weight: 800;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .deficit-item {
            padding: 10px 15px;
            border-bottom: 1px solid #fecdd3;
            color: #9f1239;
            font-size: 0.85rem;
            font-weight: 800;
            display: flex;
            justify-content: space-between;
        }

        .deficit-item:last-child {
            border-bottom: none;
        }

        /* Diagnostic Modal Cards */
        .ciblage-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 10px;
        }

        .ciblage-col {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ciblage-title {
            font-size: 1rem;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            text-align: center;
            border-radius: 14px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: slideDownTitle 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideDownTitle {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .diag-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-radius: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            border-left: 6px solid #ccc;
            min-height: 80px;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInDiag 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transition: all 0.3s ease;
        }

        @keyframes slideInDiag {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .diag-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        .diag-prob {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe4e6 100%);
            border-left-color: #a41c1c;
        }

        .diag-prob:hover {
            background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
        }

        .diag-target {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left-color: #1c7430;
        }

        .diag-target:hover {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        .diag-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .diag-prob .diag-icon {
            background: rgba(164, 28, 28, 0.1);
            color: #a41c1c;
        }

        .diag-target .diag-icon {
            background: rgba(28, 116, 48, 0.1);
            color: #1c7430;
        }

        .diag-card:hover .diag-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .diag-text {
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.4;
            flex: 1;
        }

        /* --- Map Overlay & Isolation --- */
        #map-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0);
            pointer-events: none;
            z-index: 500;
            transition: 0.4s;
            border-radius: 35px;
        }

        #map-overlay.active {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            pointer-events: auto;
        }

        #isolated-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 80%;
            height: 80%;
            z-index: 600;
            pointer-events: none;
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #isolated-box.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        #isolated-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.2));
        }

        @keyframes communePopOut {
            0% {
                transform: translate(0, 0) scale(1);
                filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
            }

            100% {
                transform: translate(-15px, -15px) scale(1.08);
                filter: drop-shadow(20px 20px 30px rgba(0, 0, 0, 0.4));
            }
        }

        .pop-active {
            animation: communePopOut 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            z-index: 100;
        }

        /* --- Pill Navigation --- */
        .bottom-nav {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            gap: 15px;
            background: rgba(226, 232, 240, 0.85);
            backdrop-filter: blur(20px);
            padding: 12px 30px;
            border-radius: 100px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            animation: slideUpNav 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.6s backwards;
        }

        @keyframes slideUpNav {
            from {
                transform: translate(-50%, 100px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .nav-btn {
            text-decoration: none;
            color: #334155;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 20px;
            border-radius: 50px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn i {
            font-size: 1.1rem;
            color: #57595a;
            transition: transform 0.3s;
        }

        .nav-btn.active i,
        .nav-btn:hover,
        .nav-btn.active {
            background: rgba(234, 88, 12, 0.12);
            color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(234, 88, 12, 0.1);
        }

        /* Styles pour le Popup de Graphe (Image 2 style) */
        .big-chart-container {
            background: #fff;
            border-radius: 25px;
            padding: 40px;
            border: 2px solid #f1f5f9;
        }

        .big-chart-main {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 380px;
            border-bottom: 3px solid #e2e8f0;
            padding-bottom: 10px;
            gap: 60px;
        }

        .big-bars-flex {
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        .big-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
        }

        .big-bar {
            width: 45px;
            border-radius: 10px 10px 0 0;
            transition: height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .big-bar-value {
            font-size: 1.4rem;
            font-weight: 900;
            margin-bottom: 15px;
            color: #1e293b;
            text-align: center;
        }

        .category-label {
            font-size: 1.1rem;
            font-weight: 900;
            margin-top: 20px;
            color: #1e293b;
            text-transform: uppercase;
            text-align: center;
            letter-spacing: 1px;
        }

        .big-legend {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 40px;
            font-size: 1.1rem;
            font-weight: 800;
            color: #475569;
        }

        .legend-pill {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color-box {
            width: 24px;
            height: 24px;
            border-radius: 6px;
        }

        .chart-box {
            cursor: pointer;
            transition: all 0.3s;
        }

        .chart-box:hover {
            transform: scale(1.02);
            filter: brightness(1.05);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: flex-start;
            /* Start from top to prevent clipping */
            z-index: 5000;
            overflow-y: auto;
            /* Allow overlay scroll */
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 35px;
            width: 90%;
            max-width: 1000px;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-wow);
            transform: scale(0.9);
            animation: modalPop 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.9) translateY(30px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 15px 25px;
            /* Compacted */
            font-weight: 800;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }

            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .modal-body {
            padding: 0;
            /* Managed by internal functions */
            overflow-y: auto;
            flex: 1;
        }

        /* Filters */
        .filter-container-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
        }

        .btn-filter-left {
            flex: 1;
            background: white;
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
        }

        .btn-filter-left:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
            border-color: var(--accent);
        }

        .btn-commune-urbaine {
            flex: 1;
            background: white;
            border: 1.5px solid var(--primary);
            color: var(--primary);
            padding: 12px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-commune-urbaine:hover,
        .btn-commune-urbaine.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.4);
        }

        /* Charts */
        .chart-box {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
            margin-bottom: 15px;
        }

        .chart-title {
            padding-bottom: 16px;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-flex-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 160px;
            gap: 5px;
            padding: 30px 5px 40px 5px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
        }

        .chart-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .c-bar {
            width: 25px;
            border-radius: 4px 4px 0 0;
            background: var(--primary);
            transition: height 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.2);
            position: relative;
        }

        .c-value {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 900;
            color: #0f172a;
            opacity: 0;
            transition: opacity 0.5s 0.8s;
        }

        .c-label {
            font-size: 0.65rem;
            font-weight: 800;
            color: #475569;
            margin-top: 10px;
            transform: rotate(-45deg);
            white-space: nowrap;
            position: absolute;
            bottom: -35px;
        }

        .badge-constat {
            background: #f1f5f9;
            color: #1e293b;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            border: 1px solid #e2e8f0;
            font-style: italic;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.65rem;
            font-weight: 800;
            color: #64748b;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .gallery-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .gallery-img-card {
            background: white;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            /* Ajout Animation Images avec durée plus lente (1s) */
            animation: slideInRight 5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }

        /* Stagger effect pour l'animation des images */
        .gallery-img-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .gallery-img-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .gallery-img-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .gallery-img-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        .gallery-img-card:nth-child(5) {
            animation-delay: 0.5s;
        }

        .gallery-img-card:nth-child(6) {
            animation-delay: 0.6s;
        }

        .gallery-img-card:nth-child(7) {
            animation-delay: 0.7s;
        }

        /* Animation modifiée: de la droite vers la gauche */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .gallery-img-card img {
            width: 100%;
            border-radius: 15px;
        }

        .gallery-caption {
            font-size: 0.7rem;
            font-weight: 800;
            color: #64748b;
            text-align: center;
            margin-top: 8px;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <style>
        /* Responsive tweaks for mise_a_niveau (in-body safe override) */
        @media (max-width: 1024px) {
            header {
                padding: 12px 18px;
                gap: 12px;
            }

            .logo-box {
                width: 60px;
                height: 60px;
            }

            .side-panel {
                width: 300px;
            }

            .chart-flex-row {
                height: 120px;
            }
        }

        @media (max-width: 768px) {
            body {
                overflow: auto;
                height: auto;
            }

            header {
                flex-direction: column;
                padding: 10px 12px;
                gap: 8px;
            }

            .side-panel {
                width: 92%;
                margin: 0 4%;
                border-radius: 16px;
                max-height: calc(100vh - 120px);
            }

            .chart-flex-row {
                height: 100px;
                padding: 18px 5px 32px 5px;
            }

            .gallery-img-card img {
                height: 120px;
                object-fit: cover;
            }

            .bottom-nav {
                position: fixed;
                bottom: 12px;
                left: 50%;
                transform: translateX(-50%);
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {
            .logo-box {
                width: 48px;
                height: 48px;
            }

            .pdti-subtitle {
                font-size: 0.9rem;
            }

            .province-text {
                font-size: 0.9rem;
            }

            .chart-flex-row {
                height: 90px;
            }

            .gallery-img-card img {
                height: 100px;
            }
        }
    </style>
    <div class="bg-master"></div>
    <div class="bg-overlay"></div>

    <header>
        <div class="logo-box" onclick="location.href='index.html'"><img src="img/logo_french.png" alt="Logo"></div>
        <div class="header-center">
            <div class="pdti-subtitle">PDTI Tan-Tan | Vers un territoire inclusif, durable et attractif</div>
            <div class="maroc-separator">
                <span class="line"></span><span class="province-text">AXE MISE À NIVEAU</span><span class="line"></span>
            </div>
        </div>
        <div class="logo-box" onclick="location.href='index.html'"><img src="img/logo_arabe.png" alt="Logo"></div>
        <div class="header-actions">
            <button onclick="showCiblage()" class="btn-icon-circle btn-diagnostic" title="Diagnostic">
                <i class="fa-solid fa-bullseye"></i>
            </button>
            <button onclick="location.href='index.html'" class="btn-icon-circle btn-home" title="Accueil">
                <i class="fa-solid fa-home"></i>
            </button>
            <button onclick="location.reload()" class="btn-icon-circle btn-reset" title="Reset">
                <i class="fa-solid fa-rotate"></i>
            </button>
        </div>


    </header>

    <div class="middle-container">
        <div class="side-panel" id="panel-left">
            <div class="filter-container-left">
                <div class="filter-row">
                    <button class="btn-filter-left" onclick="isolateGroup('urbain')">
                        <div style="width:12px; height:12px; border-radius:50%; background: var(--color-urbain);"></div>
                        Urbain
                    </button>
                    <button class="btn-filter-left" onclick="isolateGroup('rural')">
                        <div style="width:12px; height:12px; border-radius:50%; background: var(--color-rural);"></div>
                        Rural
                    </button>
                </div>
                <div id="sub-filter-urbain" class="filter-row" style="display: none; margin-top: 5px;">
                    <button id="btn-tantan" class="btn-commune-urbaine" onclick="showTanTanDetails()">Tan-Tan</button>
                    <button id="btn-elouatia" class="btn-commune-urbaine" onclick="showElOuatiaDetails()">El
                        Ouatia</button>
                </div>
                <div id="sub-filter-rural" class="filter-row" style="display: none; margin-top: 5px; flex-wrap: wrap;">
                </div>
            </div>
            <div id="panel-left-content"></div>
        </div>

        <div id="map-container">
            <div id="map-detail"></div>
            <div id="map-overlay"></div>
            <div id="isolated-box"><svg id="isolated-svg" preserveAspectRatio="xMidYMid meet"></svg></div>
        </div>

        <div class="side-panel" id="panel-right"></div>
    </div>

    <div class="bottom-nav">
        <a href="education.html" class="nav-btn"><i class="fa-solid fa-graduation-cap"></i> ÉDUCATION</a>
        <a href="sante.html" class="nav-btn"><i class="fa-solid fa-hospital-user"></i> SANTÉ</a>
        <a href="eau.html" class="nav-btn"><i class="fa-solid fa-droplet"></i> EAU</a>
        <a href="mise_a_niveau.html" class="nav-btn active"><i class="fa-solid fa-road"></i> MAN</a>
        <a href="emploi.html" class="nav-btn"><i class="fa-solid fa-briefcase"></i> EMPLOI</a>
    </div>

    <div id="alertPopup" class="modal-overlay" onclick="closePopupCiblage()">
        <div class="modal-content" id="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div><i class="fa-solid fa-triangle-exclamation"></i> <span id="popup-title">DIAGNOSTIC</span></div>
                <span class="close-modal" onclick="closePopupCiblage()"
                    style="cursor:pointer; font-size: 2rem;">&times;</span>
            </div>
            <div class="modal-body" id="popup-body"></div>
        </div>
    </div>

    <div id="programmePopup" class="modal-overlay">
        <div class="modal-content" id="prog-modal-content">
            <div class="modal-header" style="background:#ea580c; color:white;">
                <!-- Header injected by JS -->
            </div>
            <div class="modal-body" id="prog-popup-body" style="padding:0;">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map("map-detail", { zoomControl: false, attributionControl: false });
        const ruralNames = ["Chbika", "Abteh", "Msied", "Tilemzoun", "Ben Khelil"];
        const urbainNames = ["Tan-Tan", "El Ouatia"];
        let layersMap = {};
        let currentViewFunction = showMiseANiveauGlobal;

        function highlightSVGCommune(name) {
            document.querySelectorAll('.isolated-path').forEach(p => p.classList.remove('pop-active'));
            const target = document.getElementById(`path-${name.replace(/\s+/g, '-')}`);
            if (target) target.classList.add('pop-active');
        }

        // --- STARTUP / GLOBAL VIEW (REMISE A L'ORIGINE) ---
        // --- STARTUP / GLOBAL VIEW (REMISE A L'ORIGINE) ---
        function showMiseANiveauGlobal() {
            currentViewFunction = showMiseANiveauGlobal;
            // On définit d'abord les données pour le graphique d'urbanisation
            const urbData = [
                { l: "Province", v: 96, c: "#ea580c" },
                { l: "Région", v: 66.8, c: "#fbbf24" },
                { l: "National", v: 62.8, c: "#94a3b8" }
            ];

            // Génération du HTML pour les barres d'urbanisation
            let urbHtml = urbData.map(d => `
        <div class="chart-col">
            <div class="c-value">${d.v}</div>
            <div class="c-bar" style="height:0; background:${d.c};" data-height="${(d.v / 100) * 120}"></div>
            <div class="c-label">${d.l}</div>
        </div>`).join('');

            document.getElementById('panel-left-content').innerHTML = `
        <div class="ui-card">
            <div class="card-profile-header">organisation comunale</div>
            <div class="indicator-row">
                <div class="indicator-icon"><i class="fa-solid fa-tree"></i></div>
                <div class="indicator-label">02 communes urbaines</div>
            </div>
            <div class="indicator-row">
                <div class="indicator-icon"><i class="fa-solid fa-city"></i></div>
                <div class="indicator-label">05 communes rurales</div>
            </div>
        </div>

        <div class="chart-box" onclick="showGraphPopup('urb')" style="margin-bottom: 15px; cursor: pointer;">
            <div class="chart-title" style="color:#ea580c; display: flex; justify-content: space-between; align-items: center;">
                <div class="card-profile-header" style="background: linear-gradient(90deg, #ea580c, #f59e0b); width: 100%;">TAUX D’URBANISATION (%)</div>
            </div>
            <div class="chart-flex-row" style="display: flex; justify-content: space-around; align-items: flex-end; padding: 20px 0;">
                ${urbHtml}
            </div>
        </div>

            <div class="ui-dashboard" style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 480px; margin: 10px auto; background: #ffffff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); overflow: hidden; border: 1px solid #eee;">
    
                <div style="background:  #ff5700; color: white; padding: 25px 20px; margin: 15px; border-radius: 15px; text-align: left; font-weight: 800; font-size: 0.95rem; line-height: 1.5; text-transform: uppercase; letter-spacing: 0.5px;">
                    UNE CONCENTRATION MASSIVE DE LA POPULATION,<br>
                    DES SERVICES ET DES INFRASTRUCTURES SUR UN<br>
                    ESPACE RESTREINT
                </div>
            </div>
    `;

            // --- LE RESTE DU PANNEAU DROIT RESTE INCHANGÉ ---
            const povData = [
                { l: "National", v: 6.8, c: "#1e3a8a" },
                { l: "Région", v: 4.9, c: "#8b9dc3" },
                { l: "Province", v: 3.7, c: "#15803d" }
            ];

            let povHtml = povData.map(d => `
        <div class="chart-col">
          <div class="c-value">${d.v}</div>
          <div class="c-bar" style="height:0; background:${d.c};" data-height="${(d.v / 10) * 120}"></div>
          <div class="c-label">${d.l}</div>
        </div>`).join('');

            document.getElementById('panel-right').innerHTML = `
        <div class="ui-card" style="padding:15px;">
            <div style="background:#cc0000; color:white; font-weight:800; text-align:center; padding:10px; border-radius:10px; margin-bottom:15px; text-transform:uppercase;">Constat majeur</div>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                <span class="badge-constat">Déficit d’équité territoriale</span>
                <span class="badge-constat">Manque de ressources financières des CT</span>
                <span class="badge-constat">Infrastructure dégradée</span>
                <span class="badge-constat">Accès limité aux services sociaux de base</span>
                <span class="badge-constat">Défis environnementaux</span>
                <span class="badge-constat">Faible attractivité territoriale</span>
            </div>
        </div>

    `;

            animateBars();
        }


        // --- RURAL FUNCTIONS (MODIFIED: Graphs Left, 4 Images Right) ---
        function showRuralLeft() {
            currentViewFunction = showRuralLeft;
            closeView();
            document.getElementById('sub-filter-urbain').style.display = 'none';
            document.getElementById('sub-filter-rural').style.display = 'flex';

            // 1. LEFT PANEL: The Graphs from 'rural - gouche.png' (Stacked)
            const povData = [
                { l: "Nat.", v: 6.8, c: "#1e3a8a" },
                { l: "Rég.", v: 4.9, c: "#94a3b8" },
                { l: "Prov.", v: 3.7, c: "#15803d" },
                { l: "Ben kh.", v: 16.5, c: "#ea580c" },
                { l: "Chbik.", v: 31.3, c: "#ea580c" },
                { l: "Abteh", v: 9.3, c: "#ea580c" },
                { l: "Tilem.", v: 20, c: "#ea580c" },
                { l: "Msied", v: 47.8, c: "#ea580c" }
            ];

            const accData = [
                { l: "Ben kh.", vals: [80, 85, 60, 0] },
                { l: "Chbik.", vals: [0, 100, 30, 0] },
                { l: "Abteh", vals: [80, 100, 10, 0] },
                { l: "Tilem.", vals: [75, 50, 20, 0] },
                { l: "Msied", vals: [60, 0, 50, 80,] }
            ];

            const habData = [
                { l: "Ben kh.", v: 40, c: "#e11d48" },
                { l: "Chbik.", v: 60, c: "#e11d48" },
                { l: "Abteh", v: 30, c: "#e11d48" },
                { l: "Tilem.", v: 95, c: "#e11d48" },
                { l: "Msied", v: 100, c: "#e11d48" }
            ];

            let povHtml = povData.map(d => `
                <div class="chart-col">
                    <div class="c-value">${d.v}</div>
                    <div class="c-bar" style="height:0; background:${d.c};" data-height="${(d.v / 50) * 120}"></div>
                    <div class="c-label">${d.l}</div>
                </div>`).join('');

            let accHtml = accData.map(d => `
                <div class="chart-col">
                    <div style="display:flex; align-items:flex-end; gap:1px; height: 120px; position: relative; justify-content: center;">
                        ${[0, 1, 2, 3].map(idx => `
                            <div class="c-bar-wrapper" style="position:relative; display:flex; flex-direction:column; align-items:center; width: 7px;">
                                <span class="tiny-val" style="position:absolute; top:-12px; font-size:5px; font-weight:bold; white-space:nowrap;">${d.vals[idx]}%</span>
                                <div class="c-bar" style="height:0; background:${['#3b82f6', '#94a3b8', '#fbbf24', 'red'][idx]}; width:7px;" data-height="${(d.vals[idx] / 100) * 120}"></div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="c-label">${d.l}</div>
                </div>`).join('');


            let habHtml = habData.map(d => `
                <div class="chart-col">
                    <div class="c-value">${d.v}%</div>
                    <div class="c-bar" style="height:0; background:${d.c};" data-height="${(d.v / 100) * 120}"></div>
                    <div class="c-label">${d.l}</div>
                </div>`).join('');

            // Inject stacked charts into LEFT panel
            document.getElementById('panel-left-content').innerHTML = `
                <div class="chart-box" onclick="showGraphPopup('rural_pov')">
                    <div class="card-profile-header" style="background: linear-gradient(90deg, #ea580c, #f59e0b);">MILIEU RURAL</div>              

                    <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>TAUX DE PAUVRETÉ (%)</span>
                    </div>
                    <div class="chart-flex-row">${povHtml}</div>
                </div>
                <div class="alert-card" style="margin-top:20px; animation: cardFadeIn 0.8s ease; text-align: center;">
                <div style="font-size:3rem; margin-bottom:15px;">⚠️</div>
                <div class="alert-msg" style="text-align: left; display: inline-block;">

                    <ul style="list-style: none; padding: 0; margin: 0; font-weight: 600; color: #0a0a0a;">

                        <li style="margin-bottom: 10px;">

                            <i class="fa-solid fa-house-chimney-crack" style="color: #ea580c; margin-right: 10px;"></i>

                            Cadre de vie précaire

                        </li>

                        <li style="margin-bottom: 10px;">

                            <i class="fa-solid fa-hospital-user" style="color: #ea580c; margin-right: 10px;"></i>

                            Manque d’équipements sociaux

                        </li>

                        <li style="margin-bottom: 10px;">

                            <i class="fa-solid fa-chart-line" style="color: #ea580c; margin-right: 10px;"></i>

                            Économie de résilience

                        </li>

                    </ul>

                </div>

            </div>
                
            `;

            // 2. RIGHT PANEL: 4 Images (Stacked Vertically)
            document.getElementById('panel-right').innerHTML = `
                <div class="gallery-container" style="grid-template-columns: 1fr;"> 
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/rural - image 1.png', 'VUE RURALE 1')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/rural - image 1.png" alt="Img 1" style="height:120px; object-fit:cover;">
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/rural - image 2.png', 'VUE RURALE 2')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/rural - image 2.png" alt="Img 2" style="height:120px; object-fit:cover;">
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/rural - image 3.png', 'VUE RURALE 3')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/rural - image 3.png" alt="Img 3" style="height:120px; object-fit:cover;">
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/rural - image 4.png', 'VUE RURALE 4')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/rural - image 4.png" alt="Img 4" style="height:120px; object-fit:cover;">
                    </div>
                </div>
            `;
            animateBars();
        }

        // --- URBAIN FUNCTIONS ---

        function showUrbainLeft() {
            currentViewFunction = showUrbainLeft;
            closeView();
            // AJOUT: On vide la partie droite spécifiquement pour la vue urbaine
            document.getElementById('panel-right').innerHTML = "";

            document.getElementById('sub-filter-rural').style.display = 'none';
            document.getElementById('sub-filter-urbain').style.display = 'flex';
            document.getElementById('panel-left-content').innerHTML = `
                <div class="ui-card">
                    <div class="card-profile-header" style="background: linear-gradient(90deg, #ea580c, #f59e0b);">MILIEU URBAIN</div>
                    <div class="indicator-row" style="animation-delay: 0.1s;">
                      <div class="indicator-icon"><i class="fa-solid fa-city"></i></div>
                      <div class="indicator-label">02 Communes</div>
                    </div>
                    <div class="indicator-row" style="animation-delay: 0.2s;">
                      <div class="indicator-icon"><i class="fa-solid fa-users"></i></div>
                      <div class="indicator-label">90 392 Habitants (96%)</div>
                    </div>
                </div>
            `;
        }

        function showTanTanDetails() {
            currentViewFunction = showTanTanDetails;
            highlightSVGCommune('Tan-Tan');
            // Logique Active Button
            document.getElementById('btn-tantan').classList.add('active');
            document.getElementById('btn-elouatia').classList.remove('active');

            document.getElementById('panel-left-content').innerHTML = `
                <div class="ui-card">
                    <div class="card-profile-header">VILLE TAN-TAN</div>
                    <div class="container" dir="ltr" style="font-family: Arial, sans-serif; max-width: 400px; margin: 20px auto; border: 2px solid #e67e22; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="background-color: #e67e22; color: white; padding: 20px 10px; text-align: center; font-weight: bold; font-size: 1.2rem; text-transform: uppercase;">
                            Equipements culturels et sportifs
                        </div>

                        <table style="width: 100%; border-collapse: collapse; background-color: white;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e67e22;">
                                    <th style="padding: 12px 8px; text-align: left; color: #e67e22; font-size: 0.9rem; border-right: 1px solid #eee;">Type d'établissement</th>
                                    <th style="padding: 12px 8px; text-align: center; color: #e67e22; font-size: 0.9rem; border-right: 1px solid #eee;">Nombre Actuel</th>
                                    <th style="padding: 12px 8px; text-align: center; color: #e67e22; font-size: 0.9rem;">Déficit</th>
                                </tr>
                            </thead>
                            <tbody style="color: #333; font-size: 0.95rem;">
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px 12px; border-right: 1px solid #eee;">Centre culturel</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">01</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-03</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee; background-color: #fff9f4;">
                                    <td style="padding: 10px 12px; font-style: italic; border-right: 1px solid #eee;">Médiathèque</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">00</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-04</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px 12px; border-right: 1px solid #eee;">Salle omnisports</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">01</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-03</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee; background-color: #fff9f4;">
                                    <td style="padding: 10px 12px; border-right: 1px solid #eee;">Terrain de proximité</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">08</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-32</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px 12px; font-style: italic; border-right: 1px solid #eee;">Maison des jeunes</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">03</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-02</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee; background-color: #fff9f4;">
                                    <td style="padding: 10px 12px; border-right: 1px solid #eee;">Centre d'accueil</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">00</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-02</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px 12px; border-right: 1px solid #eee;">Piscine couvertes</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">00</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-04</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee; background-color: #fff9f4;">
                                    <td style="padding: 10px 12px; border-right: 1px solid #eee;">Centre socio sportif</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">00</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-02</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px 12px; border-right: 1px solid #eee;">Terrain de futsall</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee;">00</td>
                                    <td style="padding: 10px; text-align: center; color: #e67e22; font-weight: bold;">-01</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                
                </div>
            `;
            document.getElementById('panel-right').innerHTML = `
                <div class="gallery-container">
                     <div class="gallery-img-card" onclick="showImagePopup('img/tantan1.png', 'Radier submergé par la crue de l’oued')" style="cursor:pointer;">
                        <img src="img/tantan1.png"><div class="gallery-caption">Radier submergé par la crue de l’oued </div>
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/pluie.png', 'La pluie: la rue devient une rivière')" style="cursor:pointer;">
                        <img src="img/pluie.png"><div class="gallery-caption">La pluie: la rue devient une rivière</div>
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/img1.png', 'PARC DE JEUX D’ENFANTS')" style="cursor:pointer;">
                        <img src="img/img1.png"><div class="gallery-caption">Parc de jeux d’enfants</div>
                    </div>     
                    <div class="gallery-img-card" onclick="showImagePopup('img/img3.png', 'Oued Ben Khlil est gravement pollué')" style="cursor:pointer;">
                        <img src="img/img3.png"><div class="gallery-caption">Oued Ben Khlil est gravement pollué</div>
                    </div>
                </div>
            `;
        }

        // --- UPDATED EL OUATIA DETAILS FUNCTION ---
        function showElOuatiaDetails() {
            currentViewFunction = showElOuatiaDetails;
            highlightSVGCommune('El Ouatia');
            // Logique Active Button
            document.getElementById('btn-elouatia').classList.add('active');
            document.getElementById('btn-tantan').classList.remove('active');

            // Partie Gauche: Liste des déficits (basé sur l'image fournie)
            document.getElementById('panel-left-content').innerHTML = `
                <div class="ui-card">
                    <div class="card-profile-header">Ville d'El Ouatia</div>
                       <div class="ui-card" style="margin-top: 15px; padding: 0; overflow: hidden; border: 2px solid #f59e0b; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 100%;">
                            <div style="background: #f59e0b; color: white; padding: 12px; font-weight: 800; text-align: center; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px;">
                                Equipements culturels et sportifs
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; background: white; font-family: 'Arial', sans-serif; table-layout: fixed;">
                                <thead>
                                    <tr style="background: #fff7ed; color: #f59e0b; font-size: 0.9rem; border-bottom: 2px solid #f59e0b;">
                                        <th style="padding: 10px 5px; text-align: left; width: 45%; padding-left: 15px;">Type</th>
                                        <th style="padding: 10px 5px; text-align: center; width: 30%;">Nombre Actuel</th>
                                        <th style="padding: 10px 5px; text-align: center; width: 25%;">Déficit</th>
                                    </tr>
                                </thead>
                                <tbody style="color: #1f2937; font-size: 0.95rem;">
                                    <tr style="border-bottom: 1px solid #ffedd5;">
                                        <td style="padding: 10px 15px; text-align: left; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Médiathèque</td>
                                        <td style="text-align: center; font-weight: bold;">00</td>
                                        <td style="text-align: center; color: #f59e0b; font-weight: 900;">-01</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ffedd5; background-color: #fffaf0;">
                                        <td style="padding: 10px 15px; text-align: left; font-weight: bold;">Terrain de proximité</td>
                                        <td style="text-align: center; font-weight: bold;">04</td>
                                        <td style="text-align: center; color: #f59e0b; font-weight: 900;">-04</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ffedd5;">
                                        <td style="padding: 10px 15px; text-align: left;">Centre d'accueil</td>
                                        <td style="text-align: center; font-weight: bold;">00</td>
                                        <td style="text-align: center; color: #f59e0b; font-weight: 900;">-02</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ffedd5; background-color: #fffaf0;">
                                        <td style="padding: 10px 15px; text-align: left;">Piscine couvertes</td>
                                        <td style="text-align: center; font-weight: bold;">00</td>
                                        <td style="text-align: center; color: #f59e0b; font-weight: 900;">-01</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ffedd5;">
                                        <td style="padding: 10px 15px; text-align: left;">Centre socio sportif</td>
                                        <td style="text-align: center; font-weight: bold;">01</td>
                                        <td style="text-align: center; color: #f59e0b; font-weight: 900;">-01</td>
                                    </tr>
                                    <tr style="background-color: #fffaf0;">
                                        <td style="padding: 10px 15px; text-align: left;">Terrain de futsall</td>
                                        <td style="text-align: center; font-weight: bold;">00</td>
                                        <td style="text-align: center; color: #f59e0b; font-weight: 900;">-01</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
            `;

            // Partie Droite: 7 Emplacements d'images (Grille)
            document.getElementById('panel-right').innerHTML = `
                <div class="gallery-container">
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/elouatia_image2.png', 'HAY ESSALAM')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/elouatia_image2.png"><div class="gallery-caption">Hay Essalam</div>
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/elouatia_image3.png', 'Voie menant au lycée technique')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/elouatia_image3.png"><div class="gallery-caption">Voie menant au lycée technique</div>
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/elouatia_image4.png', 'HAY EL MOKHAYAM')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/elouatia_image4.png"><div class="gallery-caption">Hay El Mokhayam</div>
                    </div>
                    <div class="gallery-img-card" onclick="showImagePopup('img/mise_a_niveau/elouatia_image6.png', 'QUARTIER ADMINISTRATIF')" style="cursor:pointer;">
                        <img src="img/mise_a_niveau/elouatia_image6.png"><div class="gallery-caption">Q. Administratif</div>
                    </div>
                </div>
            `;
        }

        // --- COMMON LOGIC ---

        function isolateGroup(zone) {
            zone === 'rural' ? showRuralLeft() : showUrbainLeft();
            document.getElementById('map-overlay').classList.add('active');
            document.getElementById('map-detail').style.filter = "blur(15px) grayscale(0.2) brightness(0.9)";
            const svg = document.getElementById('isolated-svg');
            svg.innerHTML = "";
            let combinedBounds = null;

            Object.keys(layersMap).forEach(name => {
                const bbox = layersMap[name]._path.getBBox();
                if (!combinedBounds) combinedBounds = { x: bbox.x, y: bbox.y, r: bbox.x + bbox.width, b: bbox.y + bbox.height };
                else {
                    combinedBounds.x = Math.min(combinedBounds.x, bbox.x); combinedBounds.y = Math.min(combinedBounds.y, bbox.y);
                    combinedBounds.r = Math.max(combinedBounds.r, bbox.x + bbox.width); combinedBounds.b = Math.max(combinedBounds.b, bbox.y + bbox.height);
                }
            });

            // Context shapes
            Object.keys(layersMap).forEach(name => {
                const layer = layersMap[name];
                const isTarget = (zone === 'rural' ? ruralNames.includes(name) : urbainNames.includes(name));
                if (!isTarget) {
                    const ctx = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    ctx.setAttribute("d", layer._path.getAttribute('d'));
                    ctx.setAttribute("fill", "#ffffff"); ctx.setAttribute("stroke", "#94a3b8"); ctx.setAttribute("stroke-width", "0.5");
                    ctx.style.opacity = "0.7"; svg.appendChild(ctx);
                }
            });

            // Target shapes
            Object.keys(layersMap).forEach(name => {
                const layer = layersMap[name];
                const isTarget = (zone === 'rural' ? ruralNames.includes(name) : urbainNames.includes(name));
                if (isTarget) {
                    const bbox = layer._path.getBBox();
                    const centerX = bbox.x + bbox.width / 2;
                    const centerY = bbox.y + bbox.height / 2;

                    // Trace
                    const trace = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    trace.setAttribute("d", layer._path.getAttribute('d')); trace.setAttribute("fill", "#e2e8f0");
                    trace.setAttribute("stroke", "#94a3b8"); trace.setAttribute("stroke-width", "0.5");
                    svg.appendChild(trace);

                    // Popping path
                    const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    p.setAttribute("d", layer._path.getAttribute('d'));

                    let pathColor = "var(--color-rural)";
                    if (name === 'Tan-Tan' || name === 'El Ouatia') pathColor = "#f97316";

                    p.setAttribute("fill", pathColor);
                    p.setAttribute("stroke", "#ffffff"); p.setAttribute("stroke-width", "1.5");
                    p.setAttribute("id", `path-${name.replace(/\s+/g, '-')}`);
                    p.setAttribute("class", "isolated-path");
                    p.style.transformOrigin = `${centerX}px ${centerY}px`;
                    svg.appendChild(p);

                    // Label
                    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    t.setAttribute("x", centerX); t.setAttribute("y", centerY + 5); t.setAttribute("text-anchor", "middle");
                    t.setAttribute("fill", "#000"); t.setAttribute("stroke", "#fff"); t.setAttribute("stroke-width", "3");
                    t.setAttribute("paint-order", "stroke"); t.setAttribute("font-size", "11"); t.setAttribute("font-weight", "900");
                    t.textContent = name; svg.appendChild(t);
                }
            });
            if (combinedBounds) svg.setAttribute('viewBox', `${combinedBounds.x - 20} ${combinedBounds.y - 20} ${combinedBounds.r - combinedBounds.x + 40} ${combinedBounds.b - combinedBounds.y + 40}`);
            document.getElementById('isolated-box').classList.add('active');
            setTimeout(() => { document.querySelectorAll('.isolated-path').forEach(p => p.classList.add('pop-active')); }, 100);
        }

        function closeView() {
            document.getElementById('map-overlay').classList.remove('active');
            document.getElementById('map-detail').style.filter = "none";
            document.getElementById('isolated-box').classList.remove('active');
        }

        const diagData = [
            { icon: "fa-road", prob: "Routes et trottoirs très dégradés", target: "Réhabilitation et modernisation de la voirie" },
            { icon: "fa-droplet-slash", prob: "Réseaux eau/assainissement vétustes", target: "Renforcement et extension des réseaux" },
            { icon: "fa-cloud-showers-heavy", prob: "Risques majeurs d'inondations", target: "Réalisation d'ouvrages de protection" },
            { icon: "fa-tree-city", prob: "Absence d'espaces verts et d'aires de jeux", target: "Aménagement de places et parcs urbains" },
            { icon: "fa-building-circle-exclamation", prob: "Quartiers périphériques sous-équipés", target: "Mise à niveau urbaine intégrée" },
            { icon: "fa-bolt-lightning", prob: "Défaillances de l'éclairage public", target: "Modernisation vers un éclairage LED" },
            { icon: "fa-person-walking-arrow-loop-left", prob: "Manque de liaisons piétonnes structurantes", target: "Aménagement d'axes principaux et corniches" },
            { icon: "fa-volleyball", prob: "Déficit en équipements sportifs de proximité", target: "Construction de terrains et centres de sport" }
        ];

        function showCiblage() {
            closeView();
            const body = document.getElementById('popup-body');
            const title = document.getElementById('popup-title');
            const modal = document.getElementById('modal-content');
            const header = document.querySelector('.modal-header');

            title.innerText = "DIAGNOSTIC & CIBLAGE : MISE À NIVEAU";
            modal.style.maxWidth = "1100px";
            header.style.background = "var(--primary)";

            let html = `
                <style>
                    .diag-grid-premium { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
                    .diag-row-wrapper { 
                        display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 12px;
                        opacity: 0; transform: translateY(20px); transition: all 0.5s ease-out;
                    }
                    .diag-row-wrapper.active { opacity: 1; transform: translateY(0); }
                    .diag-pill-new {
                        background: #fff7ed; border-radius: 50px; padding: 10px 18px; display: flex; align-items: center; gap: 15px;
                        border-left: 6px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.02);
                    }
                    .diag-pill-target { background: #f0fdf4; border-left-color: #16a34a; }
                    .header-pill-new { padding: 12px; border-radius: 50px; text-align: center; color: white; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; }
                    .btn-next-arrow {
                        position: absolute; bottom: 30px; right: 35px; width: 65px; height: 65px;
                        background: var(--primary); color: white; border: 4px solid white; border-radius: 50%;
                        display: flex; align-items: center; justify-content: center; font-size: 1.6rem; cursor: pointer;
                        box-shadow: 0 10px 25px rgba(234, 88, 12, 0.4); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000;
                        animation: pulseEntrance 0.6s 0.5s backwards;
                    }
                    .btn-next-arrow:hover { transform: scale(1.15) rotate(-10deg); background: #c2410c; }
                    @keyframes pulseEntrance { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                </style>

                <div class="diag-container-inner" style="padding: 25px;">
                    <div class="diag-grid-premium">
                        <div class="header-pill-new" style="background:#a41c1c;">État des Lieux / Déficits</div>
                        <div class="header-pill-new" style="background:#16a34a;">Objectifs de Mise à Niveau</div>
                    </div>
                    <div id="diag-rows-box">
            `;

            diagData.forEach((item, index) => {
                html += `
                    <div class="diag-row-wrapper" id="prog-row-${index}">
                        <div class="diag-pill-new">
                            <div style="width:38px; height:38px; border-radius:50%; background:white; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:1rem; flex-shrink:0;">
                                <i class="fa-solid ${item.icon}"></i>
                            </div>
                            <div style="font-size:0.95rem; font-weight:700; color:#7c2d12;">${item.prob}</div>
                        </div>
                        <div class="diag-pill-new diag-pill-target">
                            <div style="width:38px; height:38px; border-radius:50%; background:white; display:flex; align-items:center; justify-content:center; color:#16a34a; font-size:1rem; flex-shrink:0;">
                                <i class="fa-solid ${item.icon}"></i>
                            </div>
                            <div style="font-size:0.95rem; font-weight:700; color:#14532d;">${item.target}</div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
                <button onclick="showProgramme2026()" class="btn-next-arrow" title="Voir le Programme de Mise à Niveau 2026">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            `;

            body.innerHTML = html;
            document.getElementById('alertPopup').style.display = 'flex';

            setTimeout(() => {
                diagData.forEach((_, i) => {
                    setTimeout(() => {
                        const row = document.getElementById(`prog-row-${i}`);
                        if (row) row.classList.add('active');
                    }, i * 100);
                });
            }, 50);
        }

        function showProgramme2026() {
            closePopupCiblage();
            const modal = document.getElementById('programmePopup');
            const body = document.getElementById('prog-popup-body');
            const header = modal.querySelector('.modal-header');

            header.innerHTML = `
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="background:rgba(255,255,255,0.25); padding:10px; border-radius:12px;">
                        <i class="fa-solid fa-city" style="font-size:1.5rem;"></i>
                    </div>
                    <span style="font-size:1.3rem; font-weight:800; text-transform:uppercase; letter-spacing:1px;">Mise à Niveau Territoriale</span>
                </div>
                <span onclick="closeProgrammePopup()" style="font-size:2rem; cursor:pointer; opacity:0.8;">&times;</span>
            `;

            header.style.background = "linear-gradient(135deg, #ea580c 0%, #f59e0b 100%)";
            header.style.padding = "20px 45px";

            const contentBox = document.getElementById('prog-modal-content');
            contentBox.style.maxWidth = "1200px";
            contentBox.style.borderRadius = "28px";

            let html = `
                <style>
                    .prog-inner { padding: 25px; background: #fffcf9; }
                    .prog-banner { 
                        background: white; border-left: 8px solid #ea580c; padding: 15px 25px; border-radius: 16px;
                        font-size: 1.2rem; font-weight: 800; color: #7c2d12; margin-bottom: 20px;
                        box-shadow: 0 10px 30px rgba(234, 88, 12, 0.08); display: flex; align-items: center; gap: 15px; text-transform: uppercase;
                    }
                    .table-2026 { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
                    .table-2026 thead th { color: #9a3412; padding: 0 15px 5px; text-align: left; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; opacity:0.8; }
                    .table-2026 tbody tr { background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.03); opacity:0; transform:translateY(20px); animation: rowSlideIn 0.5s ease forwards; }
                    .table-2026 td { padding: 12px 15px; vertical-align: middle; color: #334155; font-weight: 600; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
                    .table-2026 td:first-child { border-left: 5px solid #fbbf24; border-top-left-radius: 14px; border-bottom-left-radius: 14px; }
                    .table-2026 td:last-child { border-right: 1px solid #f1f5f9; border-top-right-radius: 14px; border-bottom-right-radius: 14px; }
                    @keyframes rowSlideIn { to { opacity: 1; transform: translateY(0); } }
                    .pill-commune { display: inline-flex; align-items: center; gap: 6px; background: #fff7ed; color: #c2410c; padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; border: 1px solid #ffedd5; white-space: nowrap; margin-bottom: 3px; }
                    .box-cost { display: inline-flex; justify-content: center; align-items: center; width: 50px; height: 40px; background: #fff; color: #ea580c; border-radius: 10px; font-weight: 950; font-size: 1.1rem; border: 2px solid #ffedd5; box-shadow: 0 4px 8px rgba(234,88,12,0.1); }
                    .obj-list { margin:0; padding-left:15px; list-style:none; font-size: 0.85rem; }
                    .obj-list li { margin-bottom:2px; position:relative; }
                    .obj-list li::before { content: "•"; color: #ea580c; font-weight:bold; position:absolute; left:-12px; }
                    .total-bar-orange { background: #ea580c !important; color: white !important; font-weight: 900; }
                    .total-bar-orange td { color: white !important; border:none !important; padding: 15px !important; }
                    .total-val-box { display: inline-flex; border: 2px solid rgba(255,255,255,0.4); padding: 5px 15px; border-radius: 12px; background: rgba(255,255,255,0.1); font-size: 1.4rem; }
                </style>

                <div class="prog-inner">
                    <div class="prog-banner">
                        <i class="fa-solid fa-clipboard-list"></i>
                        Programme prioritaire au titre de l’année 2026
                    </div>

                    <table class="table-2026">
                        <thead>
                            <tr>
                                <th width="35%">Projet</th>
                                <th width="20%">Commune</th>
                                <th width="15%" style="text-align:center;">Coût (Mdhs)</th>
                                <th width="30%">Objectifs</th>
                            </tr>
                        </thead>
                   <tbody>
    <tr style="animation-delay: 0.1s">
        <td style="color: black; font-weight:700;">Création d'un ouvrage d'art sur Oued Ben khlil</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> Tan-Tan</span></td>
        <td align="center"><div class="box-cost" style="color: black;">25</div></td>
        <td rowspan="2">
            <ul class="obj-list" style="color: black;">
                <li>Protection contre les crues</li>
                <li>Désenclavement</li>
            </ul>
        </td>
    </tr>
    <tr style="animation-delay: 0.15s">
        <td style="color: black; font-weight:700;">Extension du pont Ain Errahma sur Oued Ben khlil</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> Tan-Tan</span></td>
        <td align="center"><div class="box-cost" style="color: black;">15</div></td>
    </tr>

    <tr style="animation-delay: 0.2s">
        <td style="color: black; font-weight:700;">Mise à niveau des quartiers sous équipés</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> Tan-Tan ; <i class="fa-solid fa-location-dot"></i> El Ouatia</span></td>
        <td align="center">
            <div class="box-cost" style="color: black;">420</div>
            <div class="box-cost" style="color: black;">180</div>
        </td>
        <td rowspan="3">
            <ul class="obj-list" style="color: black;">
                <li>Amélioration du cadre de vie de la population</li>
                <li>Soutien au développement socioéconomique</li>
                <li>Attractivité territoriale</li>
            </ul>
        </td>
    </tr>
    <tr style="animation-delay: 0.25s">
        <td style="color: black; font-weight:700;">Aménagement des axes principaux</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> El Ouatia</span></td>
        <td align="center"><div class="box-cost" style="color: black;">200</div></td>
    </tr>
    <tr style="animation-delay: 0.3s">
        <td style="color: red; font-weight:700;">Aménagement de parcs urbains publics</td>
        <td><span class="pill-commune" style="color: red;"><i class="fa-solid fa-location-dot"></i> Tan-Tan ; <i class="fa-solid fa-location-dot"></i> El Ouatia</span></td>
        <td align="center">
            <div class="box-cost" style="color: red;">95</div>
            <div class="box-cost" style="color: red;">30</div>
        </td>
    </tr>

    <tr style="animation-delay: 0.35s">
        <td style="color: black; font-weight:700;">Extension de la corniche</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> El Ouatia</span></td>
        <td align="center"><div class="box-cost" style="color: black;">50</div></td>
        <td><ul class="obj-list" style="color: black;"><li>Attractivité territoriale et valorisation du littoral</li></ul></td>
    </tr>
    <tr style="animation-delay: 0.4s">
        <td style="color: black; font-weight:700;">Protection contre les inondations</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> Abteh ; Tilemzoune ; Msied</span></td>
        <td align="center"><div class="box-cost" style="color: black;">50</div></td>
        <td><ul class="obj-list" style="color: black;"><li>Protection de la population contre les inondations</li></ul></td>
    </tr>
    <tr style="animation-delay: 0.45s">
        <td style="color: black; font-weight:700;">Création d'une ceinture verte</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> Tan-Tan ; Ben khlil</span></td>
        <td align="center"><div class="box-cost" style="color: black;">50</div></td>
        <td><ul class="obj-list" style="color: black;"><li>Protection de l'environnement</li></ul></td>
    </tr>

    <tr style="animation-delay: 0.5s">
        <td style="color: red; font-weight:700;">Création d'un centre de conférence</td>
        <td><span class="pill-commune" style="color: red;"><i class="fa-solid fa-location-dot"></i> Tan-Tan</span></td>
        <td align="center"><div class="box-cost" style="color: red;">30</div></td>
        <td><ul class="obj-list" style="color: red;"><li>Attractivité événementielle</li></ul></td>
    </tr>
    <tr style="animation-delay: 0.55s">
        <td style="color: black; font-weight:700;">Création d'une salle omnisports</td>
        <td><span class="pill-commune"><i class="fa-solid fa-location-dot"></i> Tan-Tan</span></td>
        <td align="center"><div class="box-cost" style="color: black;">20</div></td>
        <td rowspan="2">
            <ul class="obj-list" style="color: red;">
                <li>Améliorer l'accès au sport de proximité</li>
            </ul>
        </td>
    </tr>
    <tr style="animation-delay: 0.6s">
        <td style="color: red; font-weight:700;">Création de 10 terrains de proximité</td>
        <td><span class="pill-commune" style="color: red;"><i class="fa-solid fa-location-dot"></i> Tan-Tan ; El Ouatia</span></td>
        <td align="center"><div class="box-cost" style="color: red;">15</div></td>
    </tr>
    <tr style="animation-delay: 0.65s">
        <td style="color: red; font-weight:700;">Création d'un espace de loisirs</td>
        <td><span class="pill-commune" style="color: red;"><i class="fa-solid fa-location-dot"></i> Tan-Tan</span></td>
        <td align="center"><div class="box-cost" style="color: red;">08</div></td>
        <td><ul class="obj-list" style="color: red;"><li>Attractivité territoriale</li></ul></td>
    </tr>

   
                    <tr style="animation-delay: 0.7s; background: #e67e22;">
                        <td colspan="2" style="text-align:left; padding-left:25px; font-size:1.5rem; color:white; font-weight: bold;">TOTAL</td>
                        <td align="center">
                            <div class="total-val-box" style="background: white; color: #e67e22; padding: 5px 15px; border-radius: 8px; font-weight: bold;">
                                1188
                            </div>
                        </td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            `;


            body.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeProgrammePopup() {
            document.getElementById('programmePopup').style.display = 'none';
        }

        function backToDiag() {
            closeProgrammePopup();
            showCiblage();
        }

        function closePopupCiblage() {
            const titleText = document.getElementById('popup-title').innerText;
            document.getElementById('alertPopup').style.display = 'none';

            // Si on ferme le DIAGNOSTIC, on recharge la vue pour remettre les couleurs sur la carte
            // Si on ferme un GRAPHE, on ne fait rien (on reste juste sur la page actuelle sans recharger)
            if (titleText.includes("DIAGNOSTIC")) {
                if (currentViewFunction) currentViewFunction();
            }
        }
        function animateBars() {
            setTimeout(() => {
                document.querySelectorAll('.c-bar').forEach(bar => {
                    bar.style.height = bar.getAttribute('data-height') + "px";
                });
                document.querySelectorAll('.c-value').forEach(val => {
                    val.style.opacity = "1";
                });
            }, 100);
        }

        function showGraphPopup(type) {
            const modal = document.getElementById('alertPopup');
            const titleElement = document.getElementById('popup-title');
            const body = document.getElementById('popup-body');
            const modalContent = document.getElementById('modal-content');
            const modalHeader = document.querySelector('.modal-header');

            modalContent.style.maxWidth = "1000px";
            modalContent.style.borderRadius = "35px";

            let htmlArr = [];
            let titleText = "";
            let headerColor = "";

            if (type === 'urb') {
                titleText = "TAUX D’URBANISATION (%)";
                headerColor = "linear-gradient(135deg, #ea580c 0%, #f59e0b 100%)";
                const data = [
                    { label: "Province", value: 96, color: "#ea580c" },
                    { label: "Région", value: 66.8, color: "#fbbf24" },
                    { label: "National", value: 62.8, color: "#94a3b8" }
                ];

                htmlArr.push(`<div class="big-legend">
                        <div class="legend-pill"><div class="legend-color-box" style="background: #ea580c;"></div> Province</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #fbbf24;"></div> Région</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #94a3b8;"></div> National</div>
                    </div>
                    <div class="big-chart-main">
                        <div class="big-bars-flex">`);
                data.forEach(d => {
                    htmlArr.push(`
                        <div class="big-bar-wrapper">
                            <div class="big-bar-value">${d.value}</div>
                            <div class="big-bar" style="height: 0; background: ${d.color};" data-target-h="${(d.value / 100) * 320}"></div>
                            <div class="category-label">${d.label}</div>
                        </div>
                    `);
                });
                htmlArr.push(`</div></div>`);
            } else if (type === 'pov') {
                titleText = "TAUX DE PAUVRETÉ (%)";
                headerColor = "linear-gradient(135deg, #ea580c 0%, #f59e0b 100%)";
                const data = [
                    { label: "National", value: 6.8, color: "#1e3a8a" },
                    { label: "Région", value: 4.9, color: "#8b9dc3" },
                    { label: "Province", value: 3.7, color: "#15803d" }
                ];
                htmlArr.push(`<div class="big-legend">
                        <div class="legend-pill"><div class="legend-color-box" style="background: #1e3a8a;"></div> National</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #8b9dc3;"></div> Région</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #15803d;"></div> Province</div>
                    </div>
                    <div class="big-chart-main">
                        <div class="big-bars-flex">`);
                data.forEach(d => {
                    htmlArr.push(`
                        <div class="big-bar-wrapper">
                            <div class="big-bar-value">${d.value}</div>
                            <div class="big-bar" style="height: 0; background: ${d.color};" data-target-h="${(d.value / 10) * 320}"></div>
                            <div class="category-label">${d.label}</div>
                        </div>
                    `);
                });
                htmlArr.push(`</div></div>`);
            } else if (type === 'rural_pov') {
                titleText = "TAUX DE PAUVRETÉ RURALE (%)";
                headerColor = "linear-gradient(135deg, #ea580c 0%, #f59e0b 100%)";
                const data = [
                    { l: "Nat.", v: 6.8, c: "#1e3a8a" },
                    { l: "Rég.", v: 4.9, c: "#94a3b8" },
                    { l: "Prov.", v: 3.7, c: "#15803d" },
                    { l: "Ben kh.", v: 16.5, c: "#ea580c" },
                    { l: "Chbik.", v: 31.3, c: "#ea580c" },
                    { l: "Abteh", v: 9.3, c: "#ea580c" },
                    { l: "Tilem.", v: 20, c: "#ea580c" },
                    { l: "Msied", v: 47.8, c: "#ea580c" }
                ];
                htmlArr.push(`<div class="big-legend">
                        <div class="legend-pill"><div class="legend-color-box" style="background: #1e3a8a;"></div> Nat.</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #94a3b8;"></div> Rég.</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #15803d;"></div> Prov.</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #ea580c;"></div> Communes</div>
                    </div>
                    <div class="big-chart-main" style="gap: 20px;">
                        <div class="big-bars-flex" style="gap: 15px;">`);
                data.forEach(d => {
                    htmlArr.push(`
                        <div class="big-bar-wrapper" style="width: 70px;">
                            <div class="big-bar-value" style="font-size: 1.1rem;">${d.v}</div>
                            <div class="big-bar" style="height: 0; background: ${d.c}; width: 35px;" data-target-h="${(d.v / 50) * 320}"></div>
                            <div class="category-label" style="font-size: 0.8rem;">${d.l}</div>
                        </div>
                    `);
                });
                htmlArr.push(`</div></div>`);
            } else if (type === 'rural_acc') {
                titleText = "Taux d’accès aux réseaux publics (%)";
                headerColor = "linear-gradient(135deg, #ea580c 0%, #f59e0b 100%)";
                const data = [
                    { l: "Ben kh.", vals: [80, 85, 60, 0] },
                    { l: "Chbik.", vals: [0, 100, 30, 0] },
                    { l: "Abteh", vals: [80, 100, 10, 0] },
                    { l: "Tilem.", vals: [75, 50, 20, 0] },
                    { l: "Msied", vals: [60, 0, 50, 80] }
                ];
                htmlArr.push(`<div class="big-legend">
                        <div class="legend-pill"><div class="legend-color-box" style="background: #3b82f6;"></div> AEP</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #94a3b8;"></div> Elec</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: #fbbf24;"></div> Eclairage</div>
                        <div class="legend-pill"><div class="legend-color-box" style="background: red;"></div> Assain.</div>
                    </div>
                    <div class="big-chart-main" style="gap: 40px;">`);
                data.forEach(d => {
                    htmlArr.push(`
                        <div class="group-wrapper" style="display:flex; flex-direction:column; align-items:center;">
                            <div style="display:flex; align-items:flex-end; gap:8px; height: 320px; border-left: 1px dashed #ccc; padding: 0 15px;">
                                ${[0, 1, 2, 3].map(idx => `
                                    <div class="big-bar-wrapper" style="width: 25px;">
                                        <div class="big-bar-value" style="font-size: 0.8rem; margin-bottom: 5px;">${d.vals[idx]}%</div>
                                        <div class="big-bar" style="height: 0; background: ${['#3b82f6', '#94a3b8', '#fbbf24', 'red'][idx]}; width: 22px;" data-target-h="${(d.vals[idx] / 100) * 320}"></div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="category-label" style="margin-top: 15px; font-size: 0.9rem;">${d.l}</div>
                        </div>
                    `);
                });
                htmlArr.push(`</div>`);
            }

            modalHeader.style.background = headerColor;
            titleElement.innerText = titleText;
            body.innerHTML = `<div class="big-chart-container">${htmlArr.join('')}</div>`;
            modal.style.display = 'flex';

            setTimeout(() => {
                document.querySelectorAll('.big-bar').forEach(bar => {
                    const targetH = bar.getAttribute('data-target-h');
                    bar.style.height = targetH + "px";
                });
            }, 100);
        }

        const files = [{ f: "abteh.geojson", n: "Abteh" }, { f: "benkhlil.geojson", n: "Ben Khelil" }, { f: "chbika.geojson", n: "Chbika" }, { f: "commun tantan.geojson", n: "Tan-Tan" }, { f: "elouatia.geojson", n: "El Ouatia" }, { f: "msied.geojson", n: "Msied" }, { f: "tilemzoun.geojson", n: "Tilemzoun" }];
        const group = new L.FeatureGroup().addTo(map);
        files.forEach(item => {
            fetch(item.f).then(r => r.json()).then(data => {
                const l = L.geoJSON(data, {
                    style: {
                        color: "rgba(255,255,255,0.8)",
                        weight: 2,
                        fillColor: "#ea580c",
                        fillOpacity: 0.15
                    }
                }).addTo(group);
                layersMap[item.n] = l.getLayers()[0];
                if (Object.keys(layersMap).length === files.length) {
                    map.fitBounds(group.getBounds(), { padding: [50, 50] });
                    setTimeout(() => {
                        document.querySelectorAll('.ui-card').forEach((card, i) => {
                            card.style.animationDelay = (i * 0.2) + "s";
                        });
                    }, 500);
                }
            });
        });

        function showImagePopup(src, titleText) {
            const modal = document.getElementById('alertPopup'); // On réutilise la même modale
            const title = document.getElementById('popup-title');
            const body = document.getElementById('popup-body');
            const contentBox = document.getElementById('modal-content');
            const header = document.querySelector('.modal-header');

            // Configuration du style pour l'image
            contentBox.style.maxWidth = "800px";
            header.style.background = "linear-gradient(135deg, #1e293b 0%, #0f172a 100%)"; // Fond sombre pour les images
            title.innerText = titleText || "GALERIE PHOTO";

            // Injection de l'image
            body.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; background:#000; border-radius:15px; overflow:hidden;">
                    <img src="${src}" style="max-width:100%; max-height:70vh; object-fit:contain; border-radius:4px;">
                </div>
            `;

            modal.style.display = 'flex';
        }

        window.onload = function () {
            showMiseANiveauGlobal();
        };
    </script>
</body>

</html>